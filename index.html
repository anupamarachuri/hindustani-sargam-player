<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hindustani Sargam Player</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    textarea, select, input, button { width: 100%; font-size: 1em; margin-top: 10px; }
    button { padding: 10px; }
    #staff { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px; }
    #indian { font-size: 1.2em; letter-spacing: 6px; margin-top: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Hindustani Sargam Player</h2>

  <label for="raagSelect">Raag:</label>
  <select id="raagSelect">
    <option value="Yaman">Yaman</option>
    <option value="Bhupali">Bhupali</option>
    <option value="Bhairav">Bhairav</option>
  </select>

  <textarea id="sargamInput" rows="4" placeholder="Enter Sargam: e.g. Sa Re Ga Ma Pa Dha Ni Sa'"></textarea>

  <label for="tempo">Tempo (BPM):</label>
  <input type="number" id="tempo" value="80" min="40" max="240">

  <button onclick="play()">▶️ Play</button>
  <div id="indian"></div>
  <div id="staff">
    <canvas id="vfCanvas" width="700" height="200"></canvas>
  </div>

  <audio id="tanpura" src="tanpura.mp3" loop></audio>
  <audio id="click" src="click.mp3"></audio>

  <script>
const noteMap = {
  'Sa.': 48, 'Re(k).': 49, 'Re.': 50, 'Ga(k).': 51, 'Ga.': 52, 'Ma.': 53, 'Ma(t).': 54, 'Pa.': 55, 'Dha(k).': 56, 'Dha.': 57, 'Ni(k).': 58, 'Ni.': 59,
  'Sa': 60, 'Re(k)': 61, 'Re': 62, 'Ga(k)': 63, 'Ga': 64, 'Ma': 65, 'Ma(t)': 66, 'Pa': 67, 'Dha(k)': 68, 'Dha': 69, 'Ni(k)': 70, 'Ni': 71,
  "Sa'": 72, "Re(k)'": 73, "Re'": 74, "Ga(k)'": 75, "Ga'": 76, "Ma'": 77, "Ma(t)'": 78, "Pa'": 79, "Dha(k)'": 80, "Dha'": 81, "Ni(k)'": 82, "Ni'": 83,
  "Sa''": 84
};

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function play() {
  const sargamText = document.getElementById('sargamInput').value;
  const bpm = parseInt(document.getElementById('tempo').value);
  const beatDuration = 60 / bpm;
  const tokens = sargamText.trim().split(/\s+/);
  document.getElementById('indian').textContent = sargamText;

  const tanpura = document.getElementById('tanpura');
  const click = document.getElementById('click');
  tanpura.volume = 0.3;
  tanpura.play();

  let currentTime = audioCtx.currentTime;

  tokens.forEach((token, i) => {
    const midi = noteMap[token];
    if (midi != null) {
      const freq = 440 * Math.pow(2, (midi - 69) / 12);
      scheduleNote(freq, currentTime);
    }
    // Metronome
    click.currentTime = 0;
    click.play();
    currentTime += beatDuration;
  });

  // Stop tanpura after playback
  setTimeout(() => tanpura.pause(), tokens.length * beatDuration * 1000);
}

function scheduleNote(freq, time) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(freq, time);
  gain.gain.setValueAtTime(0.4, time);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start(time);
  osc.stop(time + 0.45);
}
  </script>
</body>
</html>
